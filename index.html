<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium Photobox</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #0f0f0f;
  color: white;
  text-align: center;
}

h1 { margin: 20px 0; }

.container { padding: 20px; }

.preview-wrapper {
  width: 320px;
  height: 420px;
  margin: auto;
}

video {
  width: 100%;
  height: 100%;
  object-fit: contain; /* tidak zoom */
  border-radius: 25px;
  background: black;
}

/* FLASH */
.flash {
  position: fixed;
  inset: 0;
  background: white;
  opacity: 0;
  pointer-events: none;
}

.flash.active {
  animation: flashAnim 0.3s ease;
}

@keyframes flashAnim {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* CONTROLS */
.controls { margin-top: 15px; }

button, select, input {
  margin: 6px;
  padding: 8px 14px;
  border-radius: 12px;
  border: none;
  font-size: 14px;
}

button {
  background: #ff4da6;
  color: white;
  cursor: pointer;
}

button:hover { opacity: 0.85; }

#finalCanvas {
  display: none;
  margin-top: 25px;
  border-radius: 20px;
  box-shadow: 0 30px 60px rgba(0,0,0,0.6);
}
</style>
</head>
<body>

<h1>âœ¨ Premium Photobox</h1>

<div class="container">

  <div class="preview-wrapper">
    <video id="video" autoplay playsinline></video>
  </div>

  <div id="timer" style="font-size:42px;margin:10px;"></div>

  <div class="controls">
    <select id="template">
      <option value="pink">Pink</option>
      <option value="black">Black</option>
      <option value="retro">Retro</option>
      <option value="minimal">Minimal</option>
    </select>

    <input type="file" id="logoUpload" accept="image/*">

    <button onclick="startSession()">Start 4 Photos</button>
    <button onclick="downloadStrip()">Download</button>
  </div>

  <canvas id="canvas" hidden></canvas>
  <canvas id="finalCanvas"></canvas>

</div>

<div class="flash" id="flash"></div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const finalCanvas = document.getElementById("finalCanvas");
const timerDisplay = document.getElementById("timer");
const templateSelect = document.getElementById("template");
const flash = document.getElementById("flash");
const logoUpload = document.getElementById("logoUpload");

let photos = [];
let logoImage = null;

/* INIT CAMERA */
async function initCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
}
initCamera();

/* LOGO */
logoUpload.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    logoImage = new Image();
    logoImage.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

/* START SESSION */
async function startSession() {
  photos = [];
  finalCanvas.style.display = "none";

  for (let i = 0; i < 4; i++) {
    await countdown(3);
    capturePhoto();
  }

  await generateStrip();
}

/* COUNTDOWN */
function countdown(seconds) {
  return new Promise(resolve => {
    let count = seconds;
    timerDisplay.textContent = count;
    const interval = setInterval(() => {
      count--;
      timerDisplay.textContent = count;
      if (count <= 0) {
        clearInterval(interval);
        timerDisplay.textContent = "";
        resolve();
      }
    }, 1000);
  });
}

/* CAPTURE TANPA ZOOM & TANPA CROP */
function capturePhoto() {
  flash.classList.add("active");
  setTimeout(() => flash.classList.remove("active"), 200);

  const outputWidth = 240;
  const outputHeight = 320;

  canvas.width = outputWidth;
  canvas.height = outputHeight;

  const ctx = canvas.getContext("2d");

  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, outputWidth, outputHeight);

  const videoRatio = video.videoWidth / video.videoHeight;
  const targetRatio = outputWidth / outputHeight;

  let drawWidth, drawHeight, dx, dy;

  if (videoRatio > targetRatio) {
    drawHeight = outputHeight;
    drawWidth = drawHeight * videoRatio;
    dx = (outputWidth - drawWidth) / 2;
    dy = 0;
  } else {
    drawWidth = outputWidth;
    drawHeight = drawWidth / videoRatio;
    dx = 0;
    dy = (outputHeight - drawHeight) / 2;
  }

  ctx.drawImage(video, dx, dy, drawWidth, drawHeight);

  photos.push(canvas.toDataURL("image/png"));
}

/* TEMPLATE */
function getTemplateColor() {
  const map = {
    pink: "#ffe6f2",
    black: "#111111",
    retro: "#f5deb3",
    minimal: "#ffffff"
  };
  return map[templateSelect.value];
}

/* GENERATE STRIP */
async function generateStrip() {
  const width = 400;
  const height = 1400;

  finalCanvas.width = width;
  finalCanvas.height = height;

  const ctx = finalCanvas.getContext("2d");

  ctx.fillStyle = getTemplateColor();
  ctx.fillRect(0, 0, width, height);

  let y = 80;

  for (let photo of photos) {
    const img = await loadImage(photo);

    ctx.shadowColor = "rgba(0,0,0,0.25)";
    ctx.shadowBlur = 25;
    ctx.shadowOffsetY = 10;

    ctx.fillStyle = "#fff";
    ctx.fillRect(70, y, 260, 360);

    ctx.shadowColor = "transparent";

    ctx.save();
    ctx.beginPath();
    ctx.roundRect(80, y + 10, 240, 320, 20);
    ctx.clip();
    ctx.drawImage(img, 80, y + 10, 240, 320);
    ctx.restore();

    y += 420;
  }

  const date = new Date().toLocaleDateString();
  ctx.fillStyle = "#000";
  ctx.font = "18px Arial";
  ctx.textAlign = "center";
  ctx.fillText(date, width / 2, height - 80);

  if (logoImage) {
    await new Promise(res => {
      logoImage.onload = res;
      if (logoImage.complete) res();
    });
    ctx.drawImage(logoImage, width / 2 - 50, height - 140, 100, 50);
  }

  finalCanvas.style.display = "block";
}

function loadImage(src) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = src;
  });
}

function downloadStrip() {
  const link = document.createElement("a");
  link.download = "premium-photobox.png";
  link.href = finalCanvas.toDataURL("image/png");
  link.click();
}
</script>

</body>
</html>
